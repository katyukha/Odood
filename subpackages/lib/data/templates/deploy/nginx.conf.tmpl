{% import std.format: format %}
{% import std.range: empty %}
upstream odoo_backend {
        server {{ config.odoo.http_host.empty ? config.odoo.http_host : "127.0.0.1" }}:{{ config.odoo.http_port }} weight=1 fail_timeout=200s;
}

upstream odoo_websocket {
        server {{ config.odoo.http_host.empty ? config.odoo.http_host : "127.0.0.1" }}:{{ config.odoo.websocket_port }} weight=1 fail_timeout=30s;
}

#------------------------------------------------------------------------------
# Add mapping for $connection_upgrade variable
#------------------------------------------------------------------------------
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

{% if config.nginx.ssl_on %}
# Force SSL (HTTPS)
server {
    listen   80;
    {{ config.nginx.server_name ? "server_name %s;".format(config.nginx.server_name) : ""}}

    location / {
        return 301 https://$host$request_uri;
    }
}
{% endif %}

server {
    {% if config.nginx.ssl_on %}
    listen   443 ssl;
    {% else %}
    listen   80;
    {% endif %}
    {{ config.nginx.server_name ? "server_name %s;".format(config.nginx.server_name) : ""}}

    #-----------------------------------------------------------------------
    access_log  /var/log/nginx/odoo.access.log;
    error_log   /var/log/nginx/odoo.error.log;
    #-----------------------------------------------------------------------

    {% if config.nginx.ssl_on %}
    #-----------------------------------------------------------------------
    # SSL config
    ssl_certificate     {{ config.nginx.ssl_cert }};
    ssl_certificate_key {{ config.nginx.ssl_key }};
    #-----------------------------------------------------------------------
    {% endif %}

    #-----------------------------------------------------------------------
    # global params for Odoo backend server section
    client_max_body_size 100m;

    # Proxy global settings
    # increase proxy buffer to handle some OpenERP web requests
    proxy_buffers 16 64k;
    proxy_buffer_size 128k;

    # general proxy settings
    # force timeouts if the backend dies
    proxy_connect_timeout 900s;
    proxy_send_timeout 900s;
    proxy_read_timeout 900s;
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;

    # set headers
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP $remote_addr;


    # by default, do not forward anything
    proxy_redirect off;
    proxy_buffering off;

    # use gzip for folowing types
    gzip_types text/html text/css text/less text/plain text/xml application/xml application/json application/javascript;
    #-----------------------------------------------------------------------


    location / {
        # add_header Content-Security-Policy "upgrade-insecure-requests";
        proxy_pass http://odoo_backend;
    }

    # Chat and IM related features support
    {% if config.odoo.serie >= 16 %}
    location ~* ^/(websocket|bus) {
        {% if config.nginx.ssl_on %}
	    add_header Content-Security-Policy "upgrade-insecure-requests";
        {% endif %}
        proxy_pass http://odoo_websocket;

        # Upgrade connection
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Sec-WebSocket-Protocol $http_sec_websocket_protocol;

        # Increase timeouts for websockets
        proxy_connect_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;

        # Disable proxy buffering
        proxy_buffering off;
    }
    {% else %}
    location /longpolling {
        {% if config.nginx.ssl_on %}
	    add_header Content-Security-Policy "upgrade-insecure-requests";
        {% endif %}
        proxy_pass http://odoo_websocket;

        # Increase timeouts for websockets
        proxy_connect_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;

        # Disable proxy buffering
        proxy_buffering off;
    }
    {% endif %}


    # Restrict access
    location ~* ^/(web/database/) {
        # TODO: Restrict external access here
        #    allow trusted_network;
        #    allow trusted_ip;
        #    deny all;
        {% if config.nginx.ssl_on %}
	    add_header Content-Security-Policy "upgrade-insecure-requests";
        {% endif %}
        # deny all;
        proxy_pass http://odoo_backend;
    }
    location ~* ^/(web/tests|website/info) {
        # TODO: Restrict external access here
        #    allow trusted_network;
        #    allow trusted_ip;
        #    deny all;
        {% if config.nginx.ssl_on %}
	    add_header Content-Security-Policy "upgrade-insecure-requests";
        {% endif %}
        deny all;
        # proxy_pass http://odoo_backend;
    }
    location ~* ^/(jsonrpc|xmlrpc) {
        # TODO: Restrict external access here
        #    allow trusted_network;
        #    allow trusted_ip;
        #    deny all;
        {% if config.nginx.ssl_on %}
	    add_header Content-Security-Policy "upgrade-insecure-requests";
        {% endif %}
        deny all;
        # proxy_pass http://odoo_backend;
    }

    # cache some static data in memory for 60mins.
    # under heavy load this will preserve the OpenERP Web client a little bit.
    location /web/static/ {
        proxy_cache_valid 200 60m;
        proxy_buffering    on;
        expires 864000;
        {% if config.nginx.ssl_on %}
	    add_header Content-Security-Policy "upgrade-insecure-requests";
        {% endif %}
        proxy_pass         http://odoo_backend;
    }
}

